<h1 style="font-size: 20px"><%= @subject %></h1>

<ul>
  <% @data.each do |project_data| %>
    <li><%= link_to project_data[:project].name, "#project-#{project_data[:project].id}" %></li>
  <% end %>
</ul>
<% @data.each do |project_data| %>
  <a name="<%= "project-#{project_data[:project].id}" %>"></a>
  <h1 style="font-size: 20px; margin-top: 30px; text-decoration: underline"  id="<%= "project-#{project_data[:project].id}" %>">
    <%= project_data[:project].name %>
  </h1>
  <p>
    <strong><%= t('activity_report.mailer.total_hours') %>:</strong>
    <%= number_with_precision project_data[:total_hours], precision: 2, separator: '.' %>
    <strong><%= t('activity_report.mailer.total_issues_count') %>:</strong>
    <%= project_data[:total_issues_count] %>
  </p>

  <table style="border-collapse: collapse">
    <thead>
      <tr>
        <th style="border: 1px solid #ddd; padding: 5px;"><%= t 'activity_report.mailer.user' %></th>
        <th style="border: 1px solid #ddd; padding: 5px;"><%= t 'activity_report.mailer.hours' %></th>
        <th style="border: 1px solid #ddd; padding: 5px;"><%= t 'activity_report.mailer.issues_count' %></th>
      </tr>
    </thead>
    <tbody>

      <% project_data[:time_entries].group_by(&:user).sort_by { |u, te| -te.map(&:hours).sum }.each do |user, time_entries| %>
        <tr>
          <td style="border: 1px solid #ddd; padding: 5px;"><%= user.name %></td>
          <td style="border: 1px solid #ddd; padding: 5px;"><%= number_with_precision time_entries.map(&:hours).sum, precision: 2, separator: '.' %></td>
          <td style="border: 1px solid #ddd; padding: 5px;"><%= time_entries.map(&:issue_id).uniq.size %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
  <% project_data[:time_entries].group_by(&:user).sort_by { |u, te| -te.map(&:hours).sum }.each do |user, time_entries| %>
    <br/>
    <h2 style="font-size: 18px"><%= user.name %></h2>
    <p>
      <strong><%= t('activity_report.mailer.total_hours') %>:</strong>
      <%= number_with_precision time_entries.map(&:hours).sum, precision: 2, separator: '.' %>
      <strong><%= t('activity_report.mailer.total_issues_count') %>:</strong>
      <%= time_entries.map(&:issue_id).uniq.size %>
    </p>
    <table style="border-collapse: collapse">
      <thead>
        <tr>
          <th style="border: 1px solid #ddd; padding: 5px;"><%= t 'activity_report.mailer.issue' %></th>
          <th style="border: 1px solid #ddd; padding: 5px;"><%= t 'activity_report.mailer.hours' %></th>
          <th style="border: 1px solid #ddd; padding: 5px;"><%= t 'activity_report.mailer.work_dates' %></th>
        </tr>
      </thead>
      <tbody>

        <% time_entries.group_by(&:issue).sort_by { |u, te| -te.map(&:hours).sum }.each do |issue, entries| %>
          <tr>
            <td style="border: 1px solid #ddd; padding: 5px;"><%= link_to "#{issue.id}: #{issue.subject}", issue_url(issue) %></td>
            <td style="border: 1px solid #ddd; padding: 5px;"><%= number_with_precision entries.map(&:hours).sum, precision: 2, separator: '.' %></td>
            <td style="border: 1px solid #ddd; padding: 5px;"><%= entries.sort_by(&:spent_on).map { |e| format_date(e.spent_on) }.uniq.join(', ') %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>
<% end %>
